// SPDX-License-Identifier: UNLICENSED

//                                                                      .'..,;,,cocc:::::::::::::::ccl:,,:,..
//                                                                 .';:;coc::;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:c:,c;.
//                                                             .',:cl::;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:c::;.
//                                                         ..';co:;;;;;;;;;;;;:clloddxxxxxxdc;;;;;;;;;;;;;;;;;;;;:cc,.
//                                                      ..'cc:;;;;;;;;;;:codkO0KXNWWWWWWWWWNOc;;;;;;;;;;;;;;;;;;;;;;ll'
//                                                    .,ll:;;;;;;;;;:ldk0XNWWWWWWWWWWWWWWNX0d:;;;;;;;;;;;;;;;;;;;;;;;::;.
//                                                 .'':c;;;;;;;;;:lx0XWWWWWWWWWWWWWWNXKOxoc:;;;;;;;;;;;;;;;;;;;;;;;;;;;ll.
//                                               .:do:;;;;;;;::lx0NWWWWWWWWWWNXK0Oxdoc:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:d;
//                                              'do:;;;;;;;:oOKXWWWWWWWWNX0kdoc::;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:l
//                                            .'::;;;;;;;cd0NWWWWWWWNKOxoc:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;l
//                                          .,c:;;;;;;;cdKNWWWWWWN0xoc;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:
//                                        .:lc;;;;;;;:d0NWWWWNX0xl:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:
//                                       .co:;;;;;;:oONWWWNKklc:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
//                                      'lc;;;;;;;ckXWWWN0dc;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
//                                    .,::;;;;;;:dKWWWXOo:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
//                                   .;c;;;;;;;ckNWWXkl:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
//                                  .c:;;;;;;:o0NWXkl;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:
//                                .;::;;;;;;ckXWNOo:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:
//                               .:l:;;;;;;l0NNKd:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;c
//                              'oc;;;;;;:dKNXkc;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;l
//                             'lc;;;;;;;oKXOo:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:d
//                            .c:;;;;;;;;col:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;::
//                          .;c:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;o,
//                         .ld:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:o,
//                        .lo:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;l,
//                       .co:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;c:.
//                      .lo:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:d:
//                     .co:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;lc.
//                    .lo:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;co'
//                   .lo:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:c.
//                  .od:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:o;
//                  ;d:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;lc.
//                 'l:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;c:.
//                'oc;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;c:.
//               .:c;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;co'
//               ;o:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;co'
//              'l:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;cl'
//             .:c;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;co'
//             ;o:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;co'
//            .::;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;co'
//            ;o;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;l:.
//           .::;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;l:.
//           :d:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:oc.
//           ,l;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:c;.
//           'c;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;cc.
//          .::;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;co'
//          lk:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:oc.
//          ck:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:oxd:;;;;;;;;;;;;;;;;;;;;;;;;;;;;::;.
//          ck:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;cdk0NNOc;;;;;;;;;;;;;;;;;;;;;;;;;;;co'
//          .::;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;cldOXWWWWXd:;;;;;;;;;;;;;;;;;;;;;;;;;::,.
//           'c;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;cdOKNWWWWWNKd:;;;;;;;;;;;;;;;;;;;;;;;;;cl.
//           ,l;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ckKXXXK0kxoc;;;;;;;;;;;;;;;;;;;;;;;;;:c,.
//           :x:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:ccc::;;;;;;;;;;;;;;;;;;;;;;;;;;;:oc.
//           .cl;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:lo:.
//            'oc;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:ll;.
//             'lc;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:oo;.
//              'lc;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;::::.
//               .,::;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:ll,.
//                 'do:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:lc'..
//                  .''cc:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:ol'..
//                     ..'loc:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:c:,:;'.
//                        .'.';,:lc;;;;;;;;;;;;;;;;;;;;;;:::codc,;,..
//                            .':oc:;;;:;,,,'''cc''',,,,;c,..',.
//                         .',cl:;;;;;;l,      ..
//                       .,lo:;;;;;;;;;o;
//                   .',;::;;;;;;;;;;;;o;
//                   ,o:,':ddkkkkkkxc'';.
//                      .lKWWWWWWWWWl
//                     .xWWWWWWWWWWK,
//                     lWWWWMWWWWMWl
//                    .xWWWWWWWWWWx.
//                    lWWWWWMWWWKl.
//                   .xWWWWWWWKl.
//                 .lKWWWWWWKl.
//               .lKWWWWWWWK,
//             .lKWWWWWWWWWl
//           .lKWWWWWWWWWWWl
//         ,xKWWWWWKlxWMWWWl
//       .lKWWWWWKl. lWWWWWl
//      ,KWWWWWKl.   lWWWWWl
//    .lKWWWWKl.     lWWWWWl
//   .xWWWWWK,      ,KWWWWK,
//  .xWWWWWx.       lWWWWWl
// .xWWMWWx.       .xWWWWK,
// xWWWWWx.        lWWWWWl
// WWWWWx.        ,KWWWWx.
// MWWWK,        ,KWWWWK,
// WWWWl        ,KWWWWK,
// WWWWl      .lKWWWWK,
// WWWWl     .xWWWWWK,
// WWWWl   .lKWWWWWx.
// WWWWl.,lKWWWWWKl.
// WWWWKKWWWWWWKl.
// WWWWMWWMWKxl.
// OWWWWWWWO.
//
//
// ███╗   ███╗ █████╗ ██████╗ ███████╗   ██╗    ██╗██╗████████╗██╗  ██╗   ███╗   ███╗ █████╗ ███████╗ ██████╗ ███╗   ██╗
// ████╗ ████║██╔══██╗██╔══██╗██╔════╝   ██║    ██║██║╚══██╔══╝██║  ██║   ████╗ ████║██╔══██╗██╔════╝██╔═══██╗████╗  ██║
// ██╔████╔██║███████║██║  ██║█████╗     ██║ █╗ ██║██║   ██║   ███████║   ██╔████╔██║███████║███████╗██║   ██║██╔██╗ ██║
// ██║╚██╔╝██║██╔══██║██║  ██║██╔══╝     ██║███╗██║██║   ██║   ██╔══██║   ██║╚██╔╝██║██╔══██║╚════██║██║   ██║██║╚██╗██║
// ██║ ╚═╝ ██║██║  ██║██████╔╝███████╗   ╚███╔███╔╝██║   ██║   ██║  ██║   ██║ ╚═╝ ██║██║  ██║███████║╚██████╔╝██║ ╚████║
// ╚═╝     ╚═╝╚═╝  ╚═╝╚═════╝ ╚══════╝    ╚══╝╚══╝ ╚═╝   ╚═╝   ╚═╝  ╚═╝   ╚═╝     ╚═╝╚═╝  ╚═╝╚══════╝ ╚═════╝ ╚═╝  ╚═══╝

pragma solidity ^0.8.13;

import "./eip/2981/ERC2981Collection.sol";
import "./mason/utils/EIP712Common.sol";
import "./mason/utils/AccessControl.sol";
import "./mason/utils/Toggleable.sol";
import "./mason/utils/Claimable.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/finance/PaymentSplitter.sol";
import "@openzeppelin/contracts/utils/Address.sol";
import "@openzeppelin/contracts/utils/Counters.sol";
import "erc721a/contracts/ERC721A.sol";

error ClaimExceedsMaxReservedSupply();
error ClaimExceedsMaxSupply();
error ExceedsMaxPerWallet();
error ExceedsMaxReservedSupply();
error ExceedsMaxSupply();
error InsufficientPayment();
error TokensAlreadyClaimed();

contract CPGPOP is ERC721A, ERC2981Collection, Ownable, AccessControl, Toggleable, EIP712Common, Claimable {
  using Counters for Counters.Counter;

  uint256 public MAX_SUPPLY;
  uint256 public MAX_RESERVED_SUPPLY;
  uint256 public MAX_PUBLIC_SUPPLY;
  uint256 public MAX_PER_WALLET;
  uint256 public GENESIS_MAX_PER_WALLET;
  uint256 public PRICE;
  uint256 public GENESIS_PRICE;

  PaymentSplitter private _splitter;

  constructor (
    string memory _tokenName,
    string memory _tokenSymbol,
    string memory _customBaseURI,
    address[] memory _payees,
    uint256[] memory _shares,
    uint256 _tokenPrice,
    uint256 _tokensForSale,
    uint256 _tokensReserved
  ) ERC721A(_tokenName, _tokenSymbol) {
    customBaseURI = _customBaseURI;

    MAX_SUPPLY = _tokensForSale;
    MAX_RESERVED_SUPPLY = _tokensReserved;
    MAX_PUBLIC_SUPPLY = MAX_SUPPLY - MAX_RESERVED_SUPPLY;

    MAX_PER_WALLET = 1;
    GENESIS_MAX_PER_WALLET = 2;

    PRICE = _tokenPrice;
    GENESIS_PRICE = _tokenPrice;

    // For Secondary Royalties
    _splitter = new PaymentSplitter(_payees, _shares);
    _setRoyalties(address(_splitter), 10);
  }

  /** ==================== Mint Functions ==================== **/

  // @dev Public mint function for use in the event that we decide to open the floodgates after genesis and
  //      allowlist users have had the opportunity to mint
  function mint(uint256 _count) external payable noContracts requireActiveSale{
    if(_totalMinted() - totalReservedSupply() + _count > MAX_PUBLIC_SUPPLY) revert ExceedsMaxSupply();
    if(msg.value < PRICE * _count) revert InsufficientPayment();

    uint256 numberMinted  = _numberMinted(msg.sender);
    if(numberMinted + _count > MAX_PER_WALLET) revert ExceedsMaxPerWallet();

    _mint(msg.sender, _count);
  }

  // @dev Mint function for Community/Public Allowlist. Token price is discountable and must be validated with an
  //      EIP712 signature.
  function whitelistMint(uint256 _discountedPrice, bytes calldata _signature) external payable requiresDiscount(_signature, _discountedPrice) noContracts requireActiveWhitelist {
    if(_totalMinted() - totalReservedSupply() + 1 > MAX_PUBLIC_SUPPLY) revert ExceedsMaxSupply();
    if(msg.value < _discountedPrice) revert InsufficientPayment();

    if(_numberMinted(msg.sender) + 1 > MAX_PER_WALLET) revert ExceedsMaxPerWallet();

    _mint(msg.sender, 1);
  }

  // @dev Mint function for Genesis Holders. Mints are at a fixed price, and subject to a separare minting limit.
  //      Eligibility is validated using EIP712,
  function genesisMint(uint256 _count, bytes calldata _signature) external payable requiresWhitelist(_signature) noContracts requireActiveWhitelist {
    if(_totalMinted() - totalReservedSupply() + _count > MAX_PUBLIC_SUPPLY) revert ExceedsMaxSupply();
    if(msg.value < GENESIS_PRICE * _count) revert InsufficientPayment();

    uint256 numberMinted  = _numberMinted(msg.sender) - tokensClaimed(msg.sender);
    if(numberMinted + _count > GENESIS_MAX_PER_WALLET) revert ExceedsMaxPerWallet();

    _mint(msg.sender, _count);
  }

  // @dev Mints a number of tokens to the given address. As there are no restrictions on
  //      the number of tokens which can be owner-issued, we need to keep count and exclude
  //      the them from the publicly available supply.
  function ownerMint(uint256 _count, address _recipient) external onlyOwner() {
    if(totalReservedSupply() + _count > MAX_RESERVED_SUPPLY) revert ExceedsMaxReservedSupply();

    _mint(_recipient, _count);

    for (uint256 i = 0; i < _count;) {
      reservedSupplyCounter.increment();
      unchecked { ++i; }
    }
  }

  /** ==================== Pricing ==================== **/

  function checkPrice(uint256 discountedPrice, bytes calldata signature) public view requiresDiscount(signature, discountedPrice) returns (bool) {
    return true;
  }

  function checkGenesisPrice(bytes calldata signature) public view requiresWhitelist(signature) returns (bool) {
    return true;
  }

  /** ==================== Allowances ==================== **/

  function allowedMintCount(address minter) public view returns (uint256) {
    return MAX_PER_WALLET - _numberMinted(minter);
  }

  function genesisAllowedMintCount(address minter) public view returns (uint256) {
    return GENESIS_MAX_PER_WALLET - _numberMinted(minter) + tokensClaimed(msg.sender);
  }

  /** ==================== Claiming ==================== **/

  // @dev Supports claims of free tokens from Genesis holders. These come from the reserved allocation, allowing
  //      us to be flexible around the timing of the claim. Elibility is validated using EIP712.
  function claimTokens(uint256 _count, bytes calldata signature) public payable requireActiveClaiming requiresClaim(signature, _count) noContracts {
    if(_totalMinted() - totalReservedSupply() + _count - 1 > MAX_PUBLIC_SUPPLY) revert ClaimExceedsMaxSupply();
    if(totalReservedSupply() + _count > MAX_RESERVED_SUPPLY) revert ClaimExceedsMaxReservedSupply();

    if (hasUnclaimedTokens(msg.sender)) {
      updateClaimCount(msg.sender, _count);
    } else {
      revert TokensAlreadyClaimed();
    }

    for (uint256 i = 0; i < _count;) {
      reservedSupplyCounter.increment();
      unchecked { ++i; }
    }

    _mint(msg.sender, _count);
  }

  /** ==================== Counters ==================== **/

  Counters.Counter private reservedSupplyCounter;

  function totalReservedSupply() public view returns (uint256) {
    return reservedSupplyCounter.current();
  }

  /** ==================== Admin Functions ==================== **/


  function setMaxPerWallet(uint256 _maxPerWallet) external onlyOwner {
    MAX_PER_WALLET = _maxPerWallet;
  }

  function setGenesisMaxPerWallet(uint256 _genesisMaxPerWallet) external onlyOwner {
    GENESIS_MAX_PER_WALLET = _genesisMaxPerWallet;
  }

  function setPrice(uint256 _tokenPrice) external onlyOwner {
    PRICE = _tokenPrice;
  }

  function setGenesisPrice(uint256 _genesisPrice) external onlyOwner {
    GENESIS_PRICE = _genesisPrice;
  }

  /** ==================== Whitelist ==================== **/

  function checkWhitelist(bytes calldata _signature) public view requiresWhitelist(_signature) returns (bool) {
    return true;
  }

  /** ==================== URI Handling ==================== **/

  string private customBaseURI;

  function baseTokenURI() public view returns (string memory) {
    return customBaseURI;
  }

  function setBaseURI(string memory _customBaseURI) external onlyOwner {
    customBaseURI = _customBaseURI;
  }

  function _baseURI() internal view virtual override returns (string memory) {
    return customBaseURI;
  }

  function _startTokenId() internal view virtual override returns (uint256) {
    return 1;
  }

  /** ==================== Payouts ==================== **/

  function release() external onlyOwner {
    uint256 balance = address(this).balance;

    Address.sendValue(payable(owner()), balance);
  }

  function setRoyaltyInfo(address _royaltyAddress, uint256 _percentage) external onlyOwner {
    _setRoyalties(_royaltyAddress, _percentage);
  }

  function releaseSplit(address payable _account) public virtual onlyOwner {
    _splitter.release(_account);
  }
}
