// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@((((........(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@....................@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@..................,,,....(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@...................******@@....@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@(.....................*****@@@@...@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@***********@@@@..........................................*******@@@@@..@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@#****************#@@&%%%%%%%//////.........................,*******@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@**********@@@********@@@%%%%%%%%%%%%%%%%%%%%%%%%%%%%%...........*****@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@*********@@@@@@*******@@%%%%%%%%%%%%%%%%%%%**********%%%%%%%%///.........((@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@*********@@@@@@*******@@%%%%%%%%%%%%%%%%%                 %%%%%%%%%%%........@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@####@@@@@@@#********@@....//%%%%%%%%%%%%%%%%  %%%%%%%%%% *%%%%%%%%%%%%%%%%//....(@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@***********@@@@@@......%%%%%   %%%       %%%      ((((((   (%%%%%%%%%%%.....@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@***********#@@@@@@@@@@@@((((...   %%*       %%*    ,(((((      %%%%%%%%%%%%%//...((@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@********@@@@@@@@@@@@@@@@@@@@@@@                 (((((((((      %%%%%%%%%%%%%%%%%....@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@#*****@@@@@@@@@@@@@@@@@%%(((((((((((((((((((((((((((((((((%%%%%%%%%%%////......((@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@*****@@@@@@@@@@@@@@@(((((((((((((((((((((((%%%%((((((((((..............@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@****@@@@@@@@@@@@@@(((((((((((((((((########((((((((((((((@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@****@@@@@@@@@@@@@(((((((((((((((((((((((((((((((((((((((@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@*****@@@@@@@@@@@@@((((((((((((((((((((((((((((((((((((@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@***@       @@@@@((((((((((((((((((((((((((((((((((@@@@.@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@***@(     ,(((@@@@@%%((((((((((((((((((((((((%%@@@((.....(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@***@@@    (((.....@@@@@((((((((((((((((((@@@@@@............@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@****@#((((((........((@@@@@@@@@@@@@@@@@@(((................@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@****@@.........................................*****........@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@***#@@@@@@@.................CULT COUTURE....,,****@(.......@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@****@@@@@@@@@@................................****@@.......@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@***@@@@@@@@@@@@@@@@@..*******************(((/####@...,,,,@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@****@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@***@@((((((@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@........................,****@/      @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@.........**..............****@@      @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@.........**,..............****#@@//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@.........****.................*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@.........***#@((..............,@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@.*********@@@@@.............@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@(((@@@@@@@@@@@@@((((((((@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@..........@@@@@@@@..........@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@..,,,,,,#@@@@@@@@@...,,,.##@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@........@@@@@@@@@@.......@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@........@@@@@@@@@@.......@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@.........@@@@@@@@@@.......@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@............@@@@@@@..........@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
//
// Forgotten Pixels Digital Clothes
//
// CULT COUTURE ALPHA PHASE 1
// https://www.forgottenbabies.com
//
// Twitter: https://twitter.com/babywizards
//
// Inspired by Forgotten Runes Wizard Cult
// Made with love by BillGains.eth and AcidEater for Wizstock 2022... Thanks everyone for attending!!!
//
// If you are involved in the Runiverse,
// You should probably own this.
//
//
//
//
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.10;
pragma experimental ABIEncoderV2;

import '@openzeppelin/contracts/token/ERC721/extensions/ERC721Enumerable.sol';
import '@openzeppelin/contracts/access/Ownable.sol';
import '@openzeppelin/contracts/token/ERC20/IERC20.sol';
import "erc721a/contracts/extensions/ERC721ABurnable.sol";
import './BabyWizards.sol'; 


contract Wizstock is ERC721Enumerable, Ownable {
    uint256 public constant MAX_WIZARDS = 20000;

    


    uint256 public summonStartBlock =
        0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff;
    string public METADATA_PROVENANCE_HASH = '';

    address public vault;
    string private _baseTokenURI;
    address public Big_Wizards_Addr;
    address public Baby_Wizards_Addr;

    constructor(string memory baseURI)
        ERC721('ForgottenPixelsDigitalClothes', 'WIZSTOCK')
    {
        setBaseURI(baseURI);
    }

    function summonStarted() public view returns (bool) {
        return block.number >= summonStartBlock;
    }

    function summon(uint256 tokenID) public {
        require(summonStarted(), 'You act before your time');
        require(totalSupply() < MAX_WIZARDS, 'All wizards have been summoned');


         try IERC721(Big_Wizards_Addr).ownerOf(tokenID) returns (
            address wizardOwner
        ) {
            if (wizardOwner == msg.sender) {
                uint256 mintIndex = tokenID;
            _safeMint(msg.sender, mintIndex);
            }
            } catch Error(string memory) {
            // no wizard
        } 
 
 
    }

        function summonBaby(uint256 tokenID) public {
        require(summonStarted(), 'You act before your time');
        require(totalSupply() < MAX_WIZARDS, 'All wizards have been summoned');


         try ERC721A(Baby_Wizards_Addr).ownerOf(tokenID) returns (
            address wizardOwner
        ) {
            if (wizardOwner == msg.sender) {
                uint256 mintIndex = tokenID + 10000;
            _safeMint(msg.sender, mintIndex);
            }
            } catch Error(string memory) {
            // no baby
        } 
 
 
    }

    function burn(uint256 tokenId) public virtual {
        require(
            _isApprovedOrOwner(_msgSender(), tokenId),
            'ERC721Burnable: caller is not owner nor approved'
        );
        _burn(tokenId);
    }

    function tokensOfOwner(address _owner)
        external
        view
        returns (uint256[] memory)
    {
        uint256 tokenCount = balanceOf(_owner);
        if (tokenCount == 0) {
            // Return an empty array
            return new uint256[](0);
        } else {
            uint256[] memory result = new uint256[](tokenCount);
            uint256 index;
            for (index = 0; index < tokenCount; index++) {
                result[index] = tokenOfOwnerByIndex(_owner, index);
            }
            return result;
        }
    }

    function baseURI() public view returns (string memory) {
        return _baseTokenURI;
    }

    /*
     * Only the owner can do these things
     */

    function setProvenanceHash(string memory _hash) public onlyOwner {
        METADATA_PROVENANCE_HASH = _hash;
    }

    function setBaseURI(string memory _newBaseURI) public onlyOwner {
        _baseTokenURI = _newBaseURI;
    }

    function setBigWizAddr(address Big_Wizards_Addr_) public onlyOwner{
        Big_Wizards_Addr = Big_Wizards_Addr_;
    }

    function setBabyWizAddr(address Baby_Wizards_Addr_) public onlyOwner{
        Baby_Wizards_Addr = Baby_Wizards_Addr_;
    }

    function setSummonStartBlock(uint256 _newSummonStartBlock)
        public
        onlyOwner
    {
        summonStartBlock = _newSummonStartBlock;
    }

    function babyCheck(uint256 tokenId) public view virtual returns (address) {
        address owner = ERC721A(Baby_Wizards_Addr).ownerOf(tokenId);
        require(owner != address(0), "ERC721: owner query for nonexistent token");
        return owner;
    }


    function adultCheck(uint256 tokenId) public view virtual returns (address) {
        address owner = IERC721(Big_Wizards_Addr).ownerOf(tokenId);
        require(owner != address(0), "ERC721: owner query for nonexistent token");
        return owner;
    }



    function setVault(address _newVaultAddress) public onlyOwner {
        vault = _newVaultAddress;
    }

    function withdraw(uint256 _amount) public onlyOwner {
        require(address(vault) != address(0), 'no vault');
        require(payable(vault).send(_amount));
    }

    function withdrawAll() public payable onlyOwner {
        require(address(vault) != address(0), 'no vault');
        require(payable(vault).send(address(this).balance));
    }

    function forwardERC20s(IERC20 _token, uint256 _amount) public onlyOwner {
        require(address(vault) != address(0));
        _token.transfer(vault, _amount);
    }

    function reserve(uint256 _numWizards) public onlyOwner {
        uint256 currentSupply = totalSupply();
        require(totalSupply() * _numWizards <= 80, 'Exceeded reserved supply');
        require(!summonStarted(), 'You act too late');
        uint256 index;
        for (index = 0; index < _numWizards; index++) {
            _safeMint(owner(), currentSupply + index);
        }
    }

    function renounceOwnership() public override onlyOwner {}


}