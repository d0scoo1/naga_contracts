////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                                            //
//      NNNNNNNN        NNNNNNNN   ffffffffffffffff           tttt                                               iiii                         //
//      N:::::::N       N::::::N  f::::::::::::::::f       ttt:::t                                              i::::i                        //
//      N::::::::N      N::::::N f::::::::::::::::::f      t:::::t                                               iiii                         //
//      N:::::::::N     N::::::N f::::::fffffff:::::f      t:::::t                                                                            //
//      N::::::::::N    N::::::N f:::::f       ffffffttttttt:::::ttttttt      aaaaaaaaaaaaa  nnnn  nnnnnnnn    iiiiiii   aaaaaaaaaaaaa        //
//      N:::::::::::N   N::::::N f:::::f             t:::::::::::::::::t      a::::::::::::a n:::nn::::::::nn  i:::::i   a::::::::::::a       //
//      N:::::::N::::N  N::::::Nf:::::::ffffff       t:::::::::::::::::t      aaaaaaaaa:::::an::::::::::::::nn  i::::i   aaaaaaaaa:::::a      //
//      N::::::N N::::N N::::::Nf::::::::::::f       tttttt:::::::tttttt               a::::ann:::::::::::::::n i::::i            a::::a      //
//      N::::::N  N::::N:::::::Nf::::::::::::f             t:::::t              aaaaaaa:::::a  n:::::nnnn:::::n i::::i     aaaaaaa:::::a      //
//      N::::::N   N:::::::::::Nf:::::::ffffff             t:::::t            aa::::::::::::a  n::::n    n::::n i::::i   aa::::::::::::a      //
//      N::::::N    N::::::::::N f:::::f                   t:::::t           a::::aaaa::::::a  n::::n    n::::n i::::i  a::::aaaa::::::a      //
//      N::::::N     N:::::::::N f:::::f                   t:::::t    tttttta::::a    a:::::a  n::::n    n::::n i::::i a::::a    a:::::a      //
//      N::::::N      N::::::::Nf:::::::f                  t::::::tttt:::::ta::::a    a:::::a  n::::n    n::::ni::::::ia::::a    a:::::a      //
//      N::::::N       N:::::::Nf:::::::f                  tt::::::::::::::ta:::::aaaa::::::a  n::::n    n::::ni::::::ia:::::aaaa::::::a      //
//      N::::::N        N::::::Nf:::::::f                    tt:::::::::::tt a::::::::::aa:::a n::::n    n::::ni::::::i a::::::::::aa:::a     //
//      NNNNNNNN         NNNNNNNfffffffff                      ttttttttttt    aaaaaaaaaa  aaaa nnnnnn    nnnnnniiiiiiii  aaaaaaaaaa  aaaa     //
//                                                                                                                                            //
//                                                                                                                                            //
//                                                     .:~!?YPGB#&&@@@@@@&&&#BG5Y?!^:                                                         //
//                                                .^7YPB&@@@@@@@@@@@@@@@@@@@@@@@@@@@&BPJ7^.                                                   //
//                                            :!YG#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#PJ~.                                               //
//                                         ^?G&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#P7:                                            //
//                                      ^JB@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&G?:                                         //
//                                   .7G@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&P~                                       //
//                                 .?#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@B7.                                    // 
//                               .J#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@B7                                   //
//                              7#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@B~                                 //
//                            ^G@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@5.                               //
//                           7&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#~                              //
//                         .5@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@?                             //
//                        .P@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@Y                            //
//                       .G@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@Y                           //
//                       P@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@?                          //
//                      J@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@~                         //
//                     ^&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@B.                        //
//                     P@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@?                        //
//                    ^@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@B.                       //
//                    J@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@~                       //
//                    P@@@@@@@@@#G5J7!~~~~!7?YP#@@@@@@@@@@@@@@&BPJ7!~~~~~!?YPB&@@@@@@@@@@@@@&BPY?!~~~~~!7J5B&@@@@@@@@@?                       //
//                    B@@@@@@GJ~.              .^7P&@@@@@@@BY!:               :!5#@@@@@@@#5!:               :~JB@@@@@@5                       //
//                    B@@@@G^                      .7#@@@&~                      .7@@@@G!.                      ~#@@@@5                       //
//                    ^P@@@&P~                       ^&@@@7                       Y@@@#.                       !G@@@&Y.                       //
//                      ~G@@@@P^                      J@@@#:                     ~@@@@!                      !G@@@@5^                         //
//                        !G@@@@5^                    .B@@@5                    .B@@@5                     ~G@@@@P^                           //
//                          !B@@@@5:                   ~@@@@!                   J@@@#:                   ~P@@@@P~                             //
//                            7B@@@&Y:                  Y@@@#.                 ^@@@@7                  ^P@@@@G~                               //
//                              7#@@@&Y:                .B@@@5                 G@@@P                 ^5@@@@G!                                 //
//                               .?#@@@&J.               !@@@@~               ?@@@&:               :5&@@@B!                                   //
//                                 .?#@@@#?.              5@@@B.             ^&@@@?              :Y&@@@B7                                     //
//                                   .J&@@@#?.            .#@@@Y             P@@@G             :J&@@@#7.                                      //
//                                     :J&@@@#7            !@@@@~           7@@@&^           .J&@@@#?.                                        //
//                                       :Y&@@@B7           P@@@G          :&@@@J          .?#@@@#?.                                          //
//                                         :5&@@@B!         :&@@@J         P@@@G         .?#@@@&J.                                            //
//                                           ^5@@@@G!        7@@@&^       7@@@@~        7#@@@&J:                                              //
//                                             ^P@@@@G~       P@@@G      :#@@@Y       7B@@@&Y:                                                //
//                                               ~P@@@@P~     ^&@@@?     5@@@B.     !B@@@&5:                                                  //
//                                                 ~G@@@@P^    J@@@&7777?@@@@!    !G@@@@5^                                                    //
//                                                   ~G@@@@5JPB#@@@@@@@@@@@@@#G5JP@@@&5^                                                      //
//                                                    :5@@@@@@@@&#BGGPPPGGB#&@@@@@@@@J.                                                       //
//                                                 .!P&@@@@#GY7^:.         .:~7YG&@@@@#5~                                                     //
//                                               .?B@@@@BY~.                     .~Y#@@@@G!                                                   //
//                                              7#@@@@P~                            .~P@@@@G~                                                 //
//                                            :P@@@@5^                                 ^P@@@@Y.                                               //
//                                           ^#@@@#!      ::::::::   .:~!77!~^.          !#@@@G:                                              //
//                                          ^&@@@G:       G@&&&&&#:~5#&@@@@@@@#P!         :B@@@B.                                             //
//                                         .B@@@G.        B@@@@@@&B@@@@@@@@@@@@@@P.        .B@@@P                                             //
//                                         Y@@@&^         B@@@@@@@@@&BGGB@@@@@@@@@J         ^&@@@7                                            //
//                                        .#@@@Y          B@@@@@@@&7.    ^G@@@@@@@G          5@@@G                                            //
//                                        !@@@@~          B@@@@@@@?       7@@@@@@@B          !@@@&:                                           //
//                                        7@@@@^          B@@@@@@@!       !@@@@@@@B          ^@@@@^                                           //
//                                        !@@@@~          B@@@@@@@!       !@@@@@@@B          ~@@@&^                                           //
//                                        :&@@@J          B@@@@@@@!       !@@@@@@@B          Y@@@B.                                           //
//                                         P@@@#.         B@@@@@@@!       !@@@@@@@B         :&@@@J                                            //
//                                         ^&@@@5         B@@@@@@@!       !@@@@@@@B         P@@@B.                                            //
//                                          7@@@@5        B@@@@@@@!       7@@@@@@@#.       5@@@&^                                             //
//                                           7@@@@G:      ?YYYYYYY^       ^YYYYYYY?      :G@@@&~                                              //
//                                            !#@@@&?.                                 .J&@@@B^                                               //
//                                             :5@@@@#?:                             :J#@@@&J.                                                //
//                                               ~P@@@@&P!:                       :7P&@@@&Y:                                                  //
//                                                 ^Y#@@@@&GY!^.             .^7YG&@@@@BJ:                                                    //
//                                                   .!5B@@@@@@&BGPYYJJJY5PGB&@@@@@&BY~                                                       //
//                                                       ^7YG#&@@@@@@@@@@@@@@@&#GY!:                                                          //
//                                                           .^~7JY5PPPP55Y?7~:.                                                              //
//                                                                                                                                            //
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// SPDX-License-Identifier: MIT

// @title: Nftania NFT2.0
// @author: Nftania.com
// @custom: security-contact info@nftania.com
// @Contract: Nftania Airdrop
// Life is too short discover its purpose

pragma solidity 0.8.15;
   //////////////////////// Imports ////////////////////////////////////////
    import "@openzeppelin/contracts/access/Ownable.sol";
    import "@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol";
    import "@openzeppelin/contracts/security/Pausable.sol";
    import "@openzeppelin/contracts/security/ReentrancyGuard.sol";

contract NftaniaAirdrop is Pausable, Ownable, ReentrancyGuard {
    using SafeERC20 for IERC20;

   //////////////////////// Main Variables ///////////////////////////////////
    address public tokenAddress;
    address public immutable contractSigner;  
    uint256 public totalAirdropedTokens;
    uint256 public airdropID;        
    uint256 public remainingTokens;
    uint256 private minAirdrop;                           // Minimum number of tokens allowed per airdrop (in complete units not decimals)
    uint private startDate;
    uint private endDate;
    bool private tokensFinished; 
    bool private timeEnded;
    bool private closed;
    mapping (address => uint) public nextNonce; // Store next valid nonce value for each address

   //////////////////////// Events ///////////////////////////////////////////
    // Pause/unpause Smart Contract
        event ContractIsPaused (bool status);
    // Airdrop Claim                                     
        event AirdropClaim ( address indexed to, uint256 amount, uint256 indexed AirdropID, uint256 indexed Date );
    // New Airdrop Status
        event NewAirdropStatus (uint256 totalAirdropedTokens,uint256 remainingTokens, uint256 indexed Date);
    // New Airdrop Dates
        event airdropDateUpdate (uint startDate, uint endDate);
        // Withdraw Tokens 
        event WithdrawTokens (address to, uint256  amount);
            
   //////////////////////// Constructor //////////////////////////////////////            
    constructor(uint _startDate, uint _endDate, address _tokenAddress,uint256 _minAirdrop, address _contractSigner) {

        require (_startDate > block.timestamp, "Nftania Airdrop: Start date is before current time");
        require (_endDate > _startDate,"Nftania Airdrop: End Date should be after Start Date.");
        require (_tokenAddress != address(0),"Nftania Airdrop: not allowed address");
        require (_contractSigner != address(0),"Nftania Airdrop: not allowed address");
        contractSigner = _contractSigner;
        startDate = _startDate;
        endDate = _endDate;
        minAirdrop = _minAirdrop;
        tokenAddress = _tokenAddress;
    }

   //////////////////////// Fallback //////////////////////////////////////   
    fallback() external payable {} 
    receive() external payable {}

   //////////////////////// Claim Airdrop //////////////////////////////////// 
    function getAirdrop ( bytes32 msgh, uint8 v, bytes32 r, bytes32 s, uint256 amount, address to, uint256 signedNonce)
     public whenNotPaused whenNotClosed nonReentrant returns (bool) { 
        
        // Prequalify airdrop
        updateStatus();
        require(amount * 10**18 <= remainingTokens,"Nftania Airdrop: No remaining Tokens, no more Airdrop tokens are available");
        
        // Verify message
        bytes32 HashedMessage = messageHash (to, amount, signedNonce);
        bytes32 SignedHashedMessage = getSignedMessageHash (HashedMessage);
        bool nonce = nonceCheck (signedNonce);
        require(ecrecover(msgh, v, r, s) == contractSigner,"Nftania Airdrop: Invalid Signer");
        require(msgh == SignedHashedMessage,"Nftania Airdrop: Invalid Message");
        require(nonce == true,"Nftania Airdrop: This airdrop is already minted");
        
        // Update status 
        remainingTokens -= amount * 10**18;
        totalAirdropedTokens += amount; 
        airdropID += 1;
        
        // Deliver tokens
        deliverTokens (to, amount);
        
        // Events
        emit AirdropClaim (to, amount, airdropID, block.timestamp);
        emit NewAirdropStatus (totalAirdropedTokens, remainingTokens / 10**18, block.timestamp);
        return true;        
    }

   //////////////////////// function Deliver Tokens /////////////  
    function deliverTokens(address to, uint256 amount) internal {
        uint256 amountWithDecimal = amount * 10**18;
        IERC20(tokenAddress).safeTransferFrom(owner(), to, amountWithDecimal); 
    }    

   //////////////////////// function update Status /////////////  
    function updateStatus() internal {
        uint256 tokenAllowance;
        uint256 tokenBallance;
        require(block.timestamp >= startDate,"Nftania Airdrop: Airdrop has not started yet");   
        tokenAllowance = IERC20(tokenAddress).allowance(owner(), address(this));
        tokenBallance = IERC20(tokenAddress).balanceOf(owner());
        remainingTokens = min (tokenAllowance, tokenBallance);
        tokensFinished = remainingTokens < minAirdrop * 10**18;  // Checks if there is remaining tokens supply
        timeEnded = block.timestamp > endDate; // Checks if date Ended
        closed = tokensFinished || timeEnded;  
        require(!tokensFinished,"Nftania Airdrop: Airdrop tokens finished, all tokens are distributed out");   
        require(!timeEnded,"Nftania Airdrop: Airdrop time has ended");     

    }

   //////////////////////// Function Reopen Airdrpo after close /////////////  
   //Owner must make sure of enough allowance and new date before reopen
    function reopenAirdrop() public onlyOwner{
        closed = false;
    }

   //////////////////////// get Details ////////////////////////////////
    function getDetails() public view returns (address _tokenAddress, bool _tokensFinished, bool _timeEnded, bool _closed, uint _startDate, uint _endDate) {
        return (tokenAddress, tokensFinished, timeEnded, closed, startDate, endDate) ;
    }

   //////////////////////// function Minimum Value /////////////  
    function min (uint256 a ,uint256 b) internal pure returns (uint minimum) {
        if (a>b) {return b; } else{return a; }
    }

   //////////////////////// Claim Aidrop Supporting Functions ////////////////
    function messageHash(address to, uint amount, uint signedNonce ) internal pure returns (bytes32 base_msg) {
        return keccak256(abi.encodePacked(to , amount, signedNonce));
    }

    function getSignedMessageHash(bytes32 hash) internal pure returns (bytes32) {
        return keccak256(abi.encodePacked( "\x19Ethereum Signed Message:\n32" , hash ));
    }

    function nonceCheck(uint signedNonce) internal  returns (bool nonce){
        // For new airdrop: If user did not use previous airdrop with previous SignedNonce
        // value, we enable him to use the new airdrop and we update the NextNonce value to
        // the new SignedNonce plus one.
        if (signedNonce > nextNonce[msg.sender]) {
            nextNonce[msg.sender]=signedNonce+1;
            nonce = true;
        }
        // Check if the new request SignedNonce value is equal to the NextNonce ID, if its
        // equal then its valid newly issued message
        if (signedNonce == nextNonce[msg.sender]){
            
            //setting the NextNonce value, as the current nonce value is just used.
            nextNonce[msg.sender]+=1;
            nonce = true;
        }
        // in this case nonce value is already claimed and nonce is rejected(false)
        // the new request is trying to "recalim the airdrop again"
        else {
            nonce = false;
        }
    }

   //////////////////////// Set Dates //////////////////////////////////////// 
    function setDates(uint _startDate, uint _endDate) public onlyOwner returns (bool status){
        require (_endDate > _startDate, "Nftania Airdrop: End Date should be after Start Date.");
        startDate = _startDate;
        endDate = _endDate;
        emit airdropDateUpdate (startDate, endDate);
        return status = true;        
    } 

   //////////////////////// Withdraw Balance ////////////////////////////////     
    function withdrawEth(uint amount, address payable receivingWallet) public onlyOwner returns (uint256 balance , bool status)  {
        require(amount <= address(this).balance, "Nftania Airdrop: Insufficient funds");
        (bool success, ) = receivingWallet.call{value: amount}("");
        require(success, "Error");
        return (address(this).balance,true);
    }

   //////////////////////// Withdraw Tokens ////////////////////////////////    
    function withdrawTokens (IERC20 token , address to , uint256 amount ) public onlyOwner {
        uint256 tokenBalance = token.balanceOf (address(this)) ;
        require (amount <= tokenBalance,"Nftania Airdrop: Token balance is low") ;
        token.safeTransfer(to, amount);
        emit WithdrawTokens(to, amount);
    }

   ////////////////// Modifier Checks if Not Closed  ///////////////////// 
    modifier whenNotClosed {
        require(!closed,"Nftania Airdrop: Airdrop is closed");
        _;
    }

   //////////////////////// Pause/UnPause Smart Contract ///////////////////// 
    function pause() public onlyOwner {
        _pause();
        emit ContractIsPaused (true);        
    }

    function unpause() public onlyOwner {
        _unpause();
        emit ContractIsPaused (false);
    }

   /////////////////////// Disable Renounce Ownership //////////////////////////////////// 
    function renounceOwnership() public view override onlyOwner {
        revert("Nftania Airdrop: Ownership cannot be renounced"); 
    }
}